type: custom:layout-card
layout_type: custom:grid-layout
cards:
  - type: custom:sunsynk-power-flow-card
    view_layout:
      grid-area: flow
    cardstyle: lite
    large_font: 'yes'
    show_solar: 'yes'
    panel_mode: 'no'
    inverter:
      modern: 'yes'
      colour: '#959595'
    battery:
      energy: 15960
      shutdown_soc: 20
      invert_power: 'no'
      colour: pink
      show_daily: 'yes'
    solar:
      colour: orange
      show_daily: 'yes'
      mppts: two
    load:
      colour: '#5fb6ad'
      show_daily: 'yes'
      show_aux: 'yes'
      invert_aux: 'no'
    grid:
      colour: '#5490c2'
      show_daily_buy: 'yes'
      show_daily_sell: 'no'
      no_grid_colour: '#a40013'
      show_nonessential: 'no'
    entities:
      use_timer_248: switch.toggle_system_timer
      priority_load_243: switch.toggle_priority_load
      batchargeday_70: sensor.battery_charge_day
      batdischargeday_71: sensor.battery_discharge_day
      loadday_84: sensor.daily_load_power_kwh
      grid_buy_day_76: sensor.grid_import_day_buy
      grid_sell_day_77: none
      solarday_108: sensor.daily_pv_power_kwh
      inverter_grid_voltage_154: sensor.grid_inverter_voltage
      inverter_load_freq_192: sensor.load_frequency
      inverter_out_164: sensor.inverter_output_current
      inverter_out_175: sensor.inverter_output_power
      inverter_load_grid_169: sensor.grid_power
      pv1_power_186: sensor.pv1_power
      pv2_power_187: sensor.pv2_power
      pv3_power_188: none
      pv4_power_189: none
      battery_voltage_183: sensor.battery_voltage
      battery_soc_184: sensor.battery_soc
      battery_out_190: sensor.battery_output_power
      battery_current_191: sensor.battery_output_current
      essential_power: sensor.load_power
      nonessential_power: none
      grid_external_power_172: sensor.grid_external_power
      pv1_v_109: sensor.dc1_voltage
      pv1_i_110: sensor.dc1_current
      pv2_v_111: sensor.dc2_voltage
      pv2_i_112: sensor.dc2_current
      pv3_v_113: none
      pv3_i_114: none
      pv4_v_115: none
      pv4_i_116: none
      grid_status_194: binary_sensor.grid_connected_status
      inverter_status_59: sensor.overall_state
      aux_power_166: sensor.aux_output_power
  - type: custom:plotly-graph
    view_layout:
      grid-area: graph
    entities:
      - entity: sensor.sunsynk_totalsolar
        name: |
          $fn ({ ys,meta }) =>
            "Solar" + "🔆" + "(" +ys[ys.length - 1]+"W)"
        fill: tozeroy
        line:
          color: rgb(255, 155, 48)
      - entity: sensor.load_power
        name: |
          $fn ({ ys,meta }) =>
            "Load" + "⚡" + "(" +ys[ys.length - 1]+"W)"
        fill: tozeroy
        line:
          color: rgb(95, 182, 173)
      - entity: sensor.grid_external_power
        name: |
          $fn ({ ys,meta }) =>
            "Grid" + "💡" + "(" +ys[ys.length - 1]+"W)"
        fill: tozeroy
        line:
          color: rgb(84, 144, 194)
      - entity: sensor.battery_output_power
        fill: tozeroy
        name: |
          $fn ({ ys,meta }) =>
            "Battery" + "🔋" + "(" +ys[ys.length - 1]+"W)"
        line:
          color: rgb(243, 179, 202)
      - entity: sensor.battery_soc
        name: |
          $fn ({ ys,meta }) =>
            "SOC" + "⚠️" + "(" +ys[ys.length - 1]+"%)"
        yaxis: y2
        line:
          color: red
          width: 1
          shape: spline
        fill: none
        filters:
          - sliding_window_moving_average:
              window_size: 1
              extended: true
    hours_to_show: 24
    refresh_interval: 60
    title: null
    defaults:
      entity:
        show_value: false
      yaxes:
        fixedrange: true
    layout:
      legend:
        bgcolor: rgba(0,0,0,0)
        itemsizing: constant
        font:
          size: 11
      yaxis2:
        range:
          - 20
          - 105
        fixedrange: true
      height: 410
      yaxis:
        tickmode: linear
        dtick: 1000
    config:
      scrollZoom: false
  - type: custom:plotly-graph
    view_layout:
      grid-area: daily
    entities:
      - entity: sensor.daily_pv_power_kwh
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Solar" + "🔆" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        texttemplate: '%{y}'
        filters:
          - filter: i>0
        marker:
          color: rgb(255, 155, 48)
      - entity: sensor.daily_load_power_kwh
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Load" + "⚡" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        filters:
          - filter: i>0
        texttemplate: '%{y}'
        marker:
          color: rgb(95, 182, 173)
      - entity: sensor.grid_import_day_buy
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Grid Import" + "💡" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        texttemplate: '%{y}'
        filters:
          - filter: i>0
        marker:
          color: rgb(84, 144, 194)
      - entity: sensor.battery_discharge_day
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Battery Discharge" + "🖱️" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        texttemplate: '%{y}'
        filters:
          - filter: i>0
        marker:
          color: rgb(151, 90, 182)
      - entity: sensor.battery_charge_day
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Battery Charge" + "🔋" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        texttemplate: '%{y}'
        filters:
          - filter: i>0
        marker:
          color: yellow
    hours_to_show: 5d
    title: null
    refresh_interval: 120
    defaults:
      yaxes:
        fixedrange: true
    layout:
      legend:
        bgcolor: rgba(0,0,0,0)
        itemsizing: constant
        font:
          size: 11
      height: 410
    config:
      displayModeBar: false
      scrollZoom: false
    time_offset: 12h
  - type: energy-usage-graph
    view_layout:
      grid-area: usage
    title: Energy Usage
  - type: energy-distribution
    title: Energy Distribution
    show_header_toggle: false
    view_layout:
      grid-area: energy
  - type: energy-solar-graph
    title: Solar Energy
    show_header_toggle: false
    view_layout:
      grid-area: solar
  - type: custom:plotly-graph
    view_layout:
      grid-area: total
    entities:
      - entity: sensor.total_pv_power_kwh
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Solar" + "🔆" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        width: $fn() => 1000*60*60*3
        offset: $fn() => 1000*60*60*3.5
        texttemplate: '%{y}'
        filters:
          - filter: i>0
          - force_numeric
        marker:
          color: rgb(255, 155, 48)
      - entity: sensor.total_load_power_kwh
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Load" + "⚡" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        width: $fn() => 1000*60*60*3
        offset: $fn() => 1000*60*60*7
        filters:
          - filter: i>0
          - force_numeric
        texttemplate: '%{y}'
        marker:
          color: rgb(95, 182, 173)
      - entity: sensor.total_grid_import_kwh
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Grid Import" + "💡" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        width: $fn() => 1000*60*60*3
        offset: $fn() => 1000*60*60*10.5
        texttemplate: '%{y}'
        filters:
          - filter: i>0
          - force_numeric
        marker:
          color: rgb(84, 144, 194)
      - entity: sensor.total_battery_discharge_kwh
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Bat Discharge" + "🖱️" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        width: $fn() => 1000*60*60*3
        offset: $fn() => 1000*60*60*14
        texttemplate: '%{y}'
        filters:
          - filter: i>0
          - force_numeric
        marker:
          color: rgb(151, 90, 182)
      - entity: sensor.total_battery_charge_kwh
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Bat Charge" + "🔋" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        width: $fn() => 1000*60*60*3
        offset: $fn() => 1000*60*60*17.5
        texttemplate: '%{y}'
        filters:
          - filter: i>0
          - force_numeric
        marker:
          color: yellow
    hours_to_show: current_day
    defaults:
      entity:
        line:
          width: 2
      yaxes:
        fixedrange: true
    title: null
    layout:
      barmode: group
      xaxis:
        nticks: 1
      height: 410
    time_offset: '-1m'
    config:
      displayModeBar: false
      scrollZoom: false
  - type: custom:apexcharts-card
    view_layout:
      grid-area: stats
    chart_type: donut
    header:
      show: true
      title: Generation Purpose
      show_states: true
      colorize_states: true
    apex_config:
      chart:
        toolbar:
          show: false
          autoSelected: zoom
      stroke:
        width: 1
        curve: smooth
      legend:
        show: false
      responsive:
        - breakpoint: 800
          options:
            chart:
              height: 360px
        - breakpoint: 1300
          options:
            chart:
              height: 265px
        - breakpoint: 10000
          options:
            chart:
              height: 363px
    series:
      - entity: sensor.daily_load_power_kwh
        name: Consumption
      - entity: sensor.battery_charge_day
        name: Charging
  - type: custom:apexcharts-card
    view_layout:
      grid-area: stats1
    chart_type: donut
    header:
      show: true
      title: Generation Today
      show_states: true
      colorize_states: true
    apex_config:
      chart:
        toolbar:
          show: false
          autoSelected: zoom
      stroke:
        width: 1
        curve: smooth
      legend:
        show: false
      responsive:
        - breakpoint: 800
          options:
            chart:
              height: 360px
        - breakpoint: 1300
          options:
            chart:
              height: 320px
        - breakpoint: 10000
          options:
            chart:
              height: 354px
    series:
      - entity: sensor.daily_pv_power_kwh
        name: Solar
        color: rgb(255, 155, 48)
      - entity: sensor.battery_discharge_day
        name: Battery
        color: rgb(151, 90, 182)
      - entity: sensor.grid_import_day_buy
        name: Grid
        color: rgb(84, 144, 194)
  - type: vertical-stack
    cards:
      - type: custom:plotly-graph
        entities:
          - entity: sensor.sonoff_10013bda3a_energy
            statistic: state
            name: Daily Energy
            period: day
            type: bar
            texttemplate: '%{y}'
            filters:
              - filter: i>0
        hours_to_show: 7d
        defaults:
          entity:
            line:
              width: 2
          yaxes:
            fixedrange: true
        title: Daily Pool Energy
        layout:
          xaxis:
            rangeselector:
              'y': 1.05
              buttons:
                - count: 7
                  step: day
                - count: 30
                  step: day
                - count: 90
                  step: day
        config:
          displayModeBar: false
          scrollZoom: false
      - type: entities
        entities:
          - entity: switch.sonoff_10013bda3a
            name: Pool pump
          - entity: sensor.sonoff_10013bda3a_current
            icon: mdi:current-ac
            name: Current
          - entity: sensor.sonoff_10013bda3a_power
            icon: mdi:lightning-bolt
            name: Power
    view_layout:
      grid-area: bat
  - type: vertical-stack
    cards:
      - type: custom:plotly-graph
        entities:
          - entity: sensor.daily_geyser_energy
            statistic: state
            name: Daily Energy
            period: day
            type: bar
            texttemplate: '%{y}'
            filters:
              - filter: i>0
        hours_to_show: 7d
        defaults:
          entity:
            line:
              width: 2
          yaxes:
            fixedrange: true
        title: Daily Geyser Energy
        layout:
          xaxis:
            rangeselector:
              'y': 1.05
              buttons:
                - count: 7
                  step: day
                - count: 30
                  step: day
                - count: 90
                  step: day
        config:
          displayModeBar: false
          scrollZoom: false
      - type: entities
        entities:
          - entity: switch.geyser
          - entity: sensor.tuya_geyser_current
            icon: mdi:current-ac
            name: Current
          - entity: sensor.tuya_geyser_current_consumption
            icon: mdi:lightning-bolt
            name: Power
    view_layout:
      grid-area: geyser
  - type: markdown
    content: "  ## System Timer Settings\n<table width=\"100%\"  border=0>\n  <tbody> \n  <tr>\n    <td align=\"left\">\n    <b>Time Slot</b>\n    </td>\n    <td align=\"left\">\n    <b>Battery SOC</b>\n    </td>\n    <td align=\"left\">\n\t<b>Grid</b>\n\t</td>\n  </tr>\n  <tr>\n    <td align=\"left\">\n    01:00 - 05:00\n    </td>\n    <td align=\"left\">\n    {{ states('sensor.setting_soc_timezone1') }} %\n    </td>\n    <td align=\"left\">\n\t{% if is_state('sensor.setting_grid_charge_timezone1', '1') %} <ha-icon icon=\"mdi:checkbox-marked-outline\"></ha-icon> {% else %} <ha-icon icon=\"mdi:checkbox-blank-outline\"></ha-icon> {% endif %}\n\t</td>\n  </tr>\n  <tr>\n    <td align=\"left\">\n    05:00 - 09:00\n    </td>\n    <td align=\"left\">\n    {{ states('sensor.setting_soc_timezone2') }} %\n    </td>\n    <td align=\"left\">\n\t{% if is_state('sensor.setting_grid_charge_timezone2', '1') %} <ha-icon icon=\"mdi:checkbox-marked-outline\"></ha-icon> {% else %} <ha-icon icon=\"mdi:checkbox-blank-outline\"></ha-icon> {% endif %}\n\t</td>\n  </tr>\n  <tr>\n    <td align=\"left\">\n    09:00 - 17:00\n    </td>\n    <td align=\"left\">\n    {{ states('sensor.setting_soc_timezone3') }} %\n    </td>\n    <td align=\"left\">\n\t{% if is_state('sensor.setting_grid_charge_timezone3', '1') %} <ha-icon icon=\"mdi:checkbox-marked-outline\"></ha-icon> {% else %} <ha-icon icon=\"mdi:checkbox-blank-outline\"></ha-icon> {% endif %}\n\t</td>\n  </tr>\n  <tr>\n    <td align=\"left\">\n    17:00 - 20:00\n    </td>\n    <td align=\"left\">\n    {{ states('sensor.setting_soc_timezone4') }} %\n    </td>\n    <td align=\"left\">\n\t{% if is_state('sensor.setting_grid_charge_timezone4', '1') %} <ha-icon icon=\"mdi:checkbox-marked-outline\"></ha-icon> {% else %} <ha-icon icon=\"mdi:checkbox-blank-outline\"></ha-icon> {% endif %}\n\t</td>\n  </tr>\n  <tr>\n    <td align=\"left\">\n    20:00 - 22:00\n    </td>\n    <td align=\"left\">\n    {{ states('sensor.setting_soc_timezone5') }} %\n    </td>\n    <td align=\"left\">\n\t{% if is_state('sensor.setting_grid_charge_timezone5', '1') %} <ha-icon icon=\"mdi:checkbox-marked-outline\"></ha-icon> {% else %} <ha-icon icon=\"mdi:checkbox-blank-outline\"></ha-icon> {% endif %}\n\t</td>\n  </tr>\n  <tr>\n    <td align=\"left\">\n    22:00 - 01:00\n    </td>\n    <td align=\"left\">\n    {{ states('sensor.setting_soc_timezone6') }} %\n    </td>\n    <td align=\"left\">\n\t{% if is_state('sensor.setting_grid_charge_timezone6', '1') %} <ha-icon icon=\"mdi:checkbox-marked-outline\"></ha-icon> {% else %} <ha-icon icon=\"mdi:checkbox-blank-outline\"></ha-icon> {% endif %}\n\t</td>\n  </tr>\n  </tbody>\n</table>"
    view_layout:
      grid-area: weather
  - type: custom:flex-horseshoe-card
    view_layout:
      grid-area: g1
    entities:
      - entity: sensor.sunsynk_totalsolar
        decimals: 0
        unit: W
        name: Solar
      - entity: sensor.pv1_power
        decimals: 0
        unit: W
        name: PV1
      - entity: sensor.pv2_power
        decimals: 0
        unit: W
        name: PV2
      - entity: sensor.dc1_voltage
        decimals: 0
        unit: V
      - entity: sensor.dc2_voltage
        decimals: 0
        unit: V
      - entity: sensor.dc1_current
        decimals: 1
        unit: A
      - entity: sensor.dc2_current
        decimals: 1
        unit: A
      - entity: sensor.daily_pv_power_kwh
        decimals: 2
        unit: kWh
        name: Daily
    show:
      horseshoe_style: autominmax
    layout:
      hlines:
        - id: 0
          xpos: 50
          ypos: 40
          length: 70
          styles:
            - opacity: 0.2;
      vlines:
        - id: 0
          xpos: 50
          ypos: 59
          length: 36
          styles:
            - opacity: 0.2;
      states:
        - id: 0
          entity_index: 0
          xpos: 50
          ypos: 33
          styles:
            - font-size: 3em;
            - opacity: 0.9;
        - id: 1
          entity_index: 1
          xpos: 47
          ypos: 53
          styles:
            - font-size: 1.5em;
            - text-anchor: end;
        - id: 2
          entity_index: 2
          xpos: 53
          ypos: 53
          styles:
            - text-anchor: start;
            - font-size: 1.5em;
        - id: 3
          entity_index: 3
          xpos: 46
          ypos: 63
          styles:
            - text-anchor: end;
            - font-size: 1.5em;
        - id: 4
          entity_index: 4
          xpos: 53
          ypos: 63
          styles:
            - text-anchor: start;
            - font-size: 1.5em;
        - id: 5
          entity_index: 5
          xpos: 46
          ypos: 73
          styles:
            - text-anchor: end;
            - font-size: 1.5em;
        - id: 6
          entity_index: 6
          xpos: 53
          ypos: 73
          styles:
            - text-anchor: start;
            - font-size: 1.5em;
        - id: 7
          entity_index: 7
          xpos: 0
          ypos: 7
          styles:
            - text-anchor: start;
            - font-size: 1.2em;
      icons:
        - id: 0
          entity_index: 1
          xpos: 1
          ypos: 53
          align: start
          size: 1
        - id: 1
          entity_index: 2
          xpos: 53
          ypos: 65
          align: end
          size: 0.5
      names:
        - id: 0
          entity_index: 0
          xpos: 50
          ypos: 95
          styles:
            - font-size: 1.2em;
        - id: 1
          entity_index: 1
          xpos: 15
          ypos: 45
          styles:
            - text-anchor: start;
            - font-size: 0.5em;
        - id: 2
          entity_index: 2
          xpos: 85
          ypos: 45
          styles:
            - text-anchor: end;
            - font-size: 0.5em;
        - id: 3
          entity_index: 7
          xpos: 0
          ypos: 12
          styles:
            - text-anchor: start;
            - font-size: 0.5em;
    horseshoe_scale:
      min: 0
      max: 7000
      width: 6
    color_stops:
      '0': orange
      '2000': orange
    card_mod:
      style: |
        ha-card {
          --ha-card-background: var(--card-background-color);
          color: var(--primary-color); 
        }
  - type: custom:flex-horseshoe-card
    view_layout:
      grid-area: g2
    entities:
      - entity: sensor.battery_soc
        decimals: 0
        unit: '%'
        name: BATTERY
      - entity: sensor.battery_voltage
        decimals: 2
        unit: V
      - entity: sensor.battery_output_current
        decimals: 2
        unit: A
      - entity: sensor.battery_output_power
        decimals: 0
        unit: W
      - entity: sensor.battery_discharge_day
        decimals: 2
        unit: kWh
        name: Discharge
      - entity: sensor.battery_charge_day
        decimals: 2
        unit: kWh
        name: Charge
    show:
      horseshoe_style: autominmax
    layout:
      hlines:
        - id: 0
          xpos: 50
          ypos: 40
          length: 70
          styles:
            - opacity: 0.2;
        - id: 0
          xpos: 50
          ypos: 60
          length: 70
          styles:
            - opacity: 0.2;
      vlines:
        - id: 0
          xpos: 50
          ypos: 50
          length: 18
          styles:
            - opacity: 0.2;
      states:
        - id: 0
          entity_index: 0
          xpos: 50
          ypos: 33
          styles:
            - font-size: 3em;
            - opacity: 0.9;
        - id: 1
          entity_index: 1
          xpos: 44
          ypos: 53
          styles:
            - font-size: 1.5em;
            - text-anchor: end;
        - id: 2
          entity_index: 2
          xpos: 55
          ypos: 53
          styles:
            - text-anchor: start;
            - font-size: 1.5em;
        - id: 3
          entity_index: 3
          xpos: 34
          ypos: 75
          styles:
            - text-anchor: start;
            - font-size: 2em;
        - id: 4
          entity_index: 4
          xpos: 76
          ypos: 7
          styles:
            - text-anchor: start;
            - font-size: 1.2em;
        - id: 5
          entity_index: 5
          xpos: 0
          ypos: 7
          styles:
            - text-anchor: start;
            - font-size: 1.2em;
      icons:
        - id: 0
          entity_index: 1
          xpos: 30
          ypos: 52
          align: start
          size: 1
      names:
        - id: 0
          entity_index: 0
          xpos: 50
          ypos: 95
          styles:
            - font-size: 1.2em;
        - id: 1
          entity_index: 4
          xpos: 81
          ypos: 12
          styles:
            - font-size: 0.5em;
            - text-anchor: start;
        - id: 2
          entity_index: 5
          xpos: 0
          ypos: 12
          styles:
            - font-size: 0.5em;
            - text-anchor: start;
    horseshoe_scale:
      min: 0
      max: 100
      width: 6
    color_stops:
      '0': pink
      '2000': pink
    card_mod:
      style: |
        ha-card {
          --ha-card-background: var(--card-background-color);
          color: var(--primary-color);
        }
  - type: markdown
    content: >
      {% set stage_sensor = "sensor.load_shedding_stage_eskom" %} {% set
      area_sensor = "sensor.load_shedding_area_jhbcitypower2_10_northridingah"
      %} {% set area_schedule = state_attr(area_sensor, "forecast") %} {% if
      area_schedule %}
        {% set start_time = area_schedule[0].start_time %}
        {% set end_time = area_schedule[0].end_time %}
        {% if is_state(area_sensor, "off") %}
          {% set starts_in = timedelta(minutes=state_attr(area_sensor, "starts_in")).total_seconds() | int // 60 %}
          {% set mins = starts_in % 60 %}
          {% set hrs = starts_in // 60 % 24 %}
          {% set days = starts_in // 1440 %}
          {% set alert = "Load Shedding starts in {d}d {h}h {m}m ({next})".format(d=days, m=mins, h=hrs, next=as_timestamp(start_time) | timestamp_custom("%H:%M", True)) %}
          {% if starts_in > 1440 %}
            <ha-alert alert-type="success">{{ states(stage_sensor) }}</ha-alert>
          {% elif 60 < starts_in <= 1440 %}
            <ha-alert alert-type="warning">{{ alert }}</ha-alert>
          {% else %}
            <ha-alert alert-type="error">{{ alert }}</ha-alert>
          {% endif %}
        {% else %}
          {% set ends_in = timedelta(minutes=state_attr(area_sensor, "ends_in")).total_seconds() | int // 60 %}
            {% set mins = ends_in % 60 %}
            {% set hrs = ends_in // 60 % 24 %}
            {% set days = ends_in // 1440 %}
            {% set alert = "Load Shedding ends in {d}d {h}h {m}m ({next})".format(d=days, m=mins, h=hrs, next=as_timestamp(end_time) | timestamp_custom("%H:%M", True)) %}
            <ha-alert alert-type="error">{{ alert }}</ha-alert>
        {% endif %}
      {% else %}
        {% set stage = state_attr(stage_sensor, "next_stage") %}
        {% set start_time = state_attr(stage_sensor, "next_start_time") %}
        {% set end_time = state_attr(stage_sensor, "next_end_time") %}
        {% set starts_in = timedelta(minutes=state_attr(stage_sensor, "starts_in")).total_seconds() | int // 60 %}
        {% set mins = starts_in % 60 %}
        {% set hrs = starts_in // 60 % 24 %}
        {% set days = starts_in // 1440 %}
        {% if (start_time == 0 or end_time == 0) %}
        {% set alert = "No Load Shedding" %}
        {% else %}
        {% set alert = "Stage {stage} starts in {d}d {h}h {m}m ({next})".format(stage=stage, d=days, m=mins, h=hrs, next=as_timestamp(start_time) | timestamp_custom("%H:%M", True)) %}
        {% endif %}
        <ha-alert alert-type="success">{{ alert }}</ha-alert>
      {% endif %}{% set area_forecast = state_attr(area_sensor, "forecast" )%}
      {% if area_forecast %} <table width="100%"  border=0>
        <tbody>
        {% for forecast in area_forecast[:3] %}
        <tr>
          <td align="left">
          {{ as_timestamp(forecast.start_time) | timestamp_custom("%-d %B", True) }}
          </td>
          <td align="left">
          {{ as_timestamp(forecast.start_time) | timestamp_custom("%H:%M", True) }} - {{ as_timestamp(forecast.end_time) | timestamp_custom("%H:%M", True) }}
          </td>
          <td align="right">{{ forecast.stage }}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table> {% endif %}


      {% set soc1 = states('sensor.soc_battery_time_left_friendly') %}

      {% set load1 = states('sensor.load_power') %}

      {% set socsec1 = states('sensor.soc_battery_time_left') | int %}

      {% set state = states('sensor.battery_output_power') | int %}

      {% if state <= 0 -%}
        <ha-alert alert-type="success">{{ soc1 }}</ha-alert>
      {% else %}
        {% if socsec1 > 21601 %}
        <ha-alert alert-type="success"> Battery runtime is {{ soc1 }} at current ({{state}} W) battery load</ha-alert>
        {% elif 10800 < socsec1 <= 21600 %}
        <ha-alert alert-type="warning">Battery runtime is {{ soc1 }} at current ({{state}} W) battery load</ha-alert>     
        {% elif socsec1 <= 10800 %}
        <ha-alert alert-type="error"> Battery runtime is {{ soc1 }} at current ({{state}} W) battery load</ha-alert>
        {% endif %}
      {% endif %}
    view_layout:
      grid-area: ls
  - type: custom:plotly-graph
    view_layout:
      grid-area: sg
    entities:
      - entity: sensor.daily_pv_power_kwh
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Solar" + "🔆" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        texttemplate: '%{y}'
        filters:
          - filter: i>0
        marker:
          color: rgb(255, 155, 48)
      - entity: sensor.grid_import_day_buy
        statistic: state
        name: |
          $fn ({ ys,meta }) =>
            "Grid Import" + "💡" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: bar
        texttemplate: '%{y}'
        filters:
          - filter: i>0
        marker:
          color: rgb(84, 144, 194)
      - entity: sensor.daily_load_power_kwh
        statistic: state
        show_value: true
        name: |
          $fn ({ ys,meta }) =>
            "Load" + "⚡" + "(" +ys[ys.length - 1]+"kWh)"
        period: day
        type: line
        texttemplate: '%{y}'
        line:
          color: rgb(95, 182, 173)
          width: 2
    hours_to_show: 30d
    title: null
    refresh_interval: 600
    defaults:
      yaxes:
        fixedrange: true
    layout:
      legend:
        bgcolor: rgba(0,0,0,0)
        itemsizing: constant
        font:
          size: 11
        x: 0.4
      height: 410
      barmode: stack
      xaxis:
        rangeselector:
          'y': 1.05
          buttons:
            - count: 7
              step: day
            - count: 31
              step: day
            - count: 90
              step: day
    config:
      displayModeBar: false
      scrollZoom: false
  - type: custom:plotly-graph
    view_layout:
      grid-area: m
    entities:
      - entity: sensor.daily_pv_power_kwh
        statistic: sum
        name: |
          $fn ({ ys,meta }) =>
            "Solar" + "🔆"
        period: month
        type: bar
        texttemplate: '%{y}'
        filters:
          - delta
        marker:
          color: rgb(255, 155, 48)
      - entity: sensor.daily_load_power_kwh
        statistic: sum
        name: |
          $fn ({ ys,meta }) =>
            "Load" + "⚡"
        period: month
        type: bar
        filters:
          - delta
        texttemplate: '%{y}'
        marker:
          color: rgb(95, 182, 173)
      - entity: sensor.grid_import_day_buy
        statistic: sum
        name: |
          $fn ({ ys,meta }) =>
            "Grid Import" + "💡"
        period: month
        type: bar
        texttemplate: '%{y}'
        filters:
          - delta
        marker:
          color: rgb(84, 144, 194)
      - entity: sensor.battery_discharge_day
        statistic: sum
        name: |
          $fn ({ ys,meta }) =>
            "Battery Discharge" + "🖱️"
        period: month
        type: bar
        texttemplate: '%{y}'
        filters:
          - delta
          - filter: i>0
        marker:
          color: rgb(151, 90, 182)
      - entity: sensor.battery_charge_day
        statistic: sum
        name: |
          $fn ({ ys,meta }) =>
            "Battery Charge" + "🔋"
        period: month
        type: bar
        texttemplate: '%{y}'
        filters:
          - delta
        marker:
          color: yellow
    hours_to_show: 6M
    title: Monthly Production
    refresh_interval: 600
    defaults:
      yaxes:
        fixedrange: true
    layout:
      legend:
        bgcolor: rgba(0,0,0,0)
        itemsizing: constant
        font:
          size: 11
      height: 410
    config:
      displayModeBar: false
      scrollZoom: false
    time_offset: 1M
  - type: custom:flex-horseshoe-card
    view_layout:
      grid-area: g3
    entities:
      - entity: sensor.load_power
        unit: W
        name: AC
      - entity: sensor.grid_inverter_voltage
        decimals: 0
        unit: V
      - entity: sensor.grid_frequency
        decimals: 2
        unit: Hz
        name: Grid
      - entity: sensor.grid_external_power
        decimals: 0
        unit: W
        name: Grid
      - entity: sensor.grid_import_day_buy
        decimals: 2
        unit: kWh
        name: Import
      - entity: sensor.daily_load_power_kwh
        decimals: 2
        unit: kWh
        name: Daily
    show:
      horseshoe_style: autominmax
    layout:
      hlines:
        - id: 0
          xpos: 50
          ypos: 40
          length: 70
          styles:
            - opacity: 0.2;
        - id: 0
          xpos: 50
          ypos: 60
          length: 70
          styles:
            - opacity: 0.2;
      vlines:
        - id: 0
          xpos: 50
          ypos: 50
          length: 18
          styles:
            - opacity: 0.2;
      states:
        - id: 0
          entity_index: 0
          xpos: 50
          ypos: 33
          styles:
            - font-size: 3em;
            - opacity: 0.9;
        - id: 1
          entity_index: 1
          xpos: 44
          ypos: 53
          styles:
            - font-size: 1.5em;
            - text-anchor: end;
        - id: 2
          entity_index: 2
          xpos: 55
          ypos: 53
          styles:
            - text-anchor: start;
            - font-size: 1.5em;
        - id: 3
          entity_index: 3
          xpos: 42
          ypos: 75
          styles:
            - text-anchor: start;
            - font-size: 2em;
        - id: 4
          entity_index: 4
          xpos: 75
          ypos: 7
          styles:
            - text-anchor: start;
            - font-size: 1.2em;
        - id: 5
          entity_index: 5
          xpos: 0
          ypos: 7
          styles:
            - text-anchor: start;
            - font-size: 1.2em;
      icons:
        - id: 0
          entity_index: 1
          xpos: 30
          ypos: 52
          align: start
          size: 1
      names:
        - id: 0
          entity_index: 0
          xpos: 50
          ypos: 95
          styles:
            - font-size: 1.2em;
        - id: 1
          entity_index: 4
          xpos: 85
          ypos: 12
          styles:
            - font-size: 0.5em;
            - text-anchor: start;
        - id: 2
          entity_index: 5
          xpos: 0
          ypos: 12
          styles:
            - font-size: 0.5em;
            - text-anchor: start;
        - id: 3
          entity_index: 3
          xpos: 44
          ypos: 80
          styles:
            - font-size: 0.5em;
            - text-anchor: start;
    horseshoe_scale:
      min: 0
      max: 8000
      width: 6
    color_stops:
      '0': '#5fb6ad'
      '2000': '#5fb6ad'
    card_mod:
      style: |
        ha-card {
          --ha-card-background: var(--card-background-color);
          color: var(--primary-color); 
        }
layout:
  grid-template-columns: 10% 10% 10% 10% 10% 10% 10% 10% 10% 10%
  grid-template-rows: auto
  grid-template-areas: |
    "g1 g1 g2 g2 g3 g3 ls ls weather weather"
    "flow flow flow graph graph graph graph graph stats1 stats1 "
    "total total total total daily daily daily daily stats stats "
    "sg sg sg sg sg sg sg sg sg sg"
    "m m m m m m m m m m"
    "bat bat bat bat bat geyser geyser geyser geyser geyser "
    "energy energy usage usage usage usage  solar solar  solar solar "
  justify-items: stretch
  mediaquery:
    '(max-width: 800px)':
      grid-template-columns: 100%
      grid-template-areas: |
        "ls"
        "g1"
        "g2"
        "g3"
        "flow"
        "graph"
        "daily"
        "total"
        "stats1"
        "sg"
        "m"
        "bat"
        "geyser"
        "stats"
        "energy"
        "usage"
        "solar"
        "weather"
    '(max-width: 1300px)':
      grid-template-columns: 33% 33% 33%
      grid-template-areas: |
        "g1 g2 g3"
        "flow graph graph"
        "stats1 daily daily"
        "stats total total"
        "sg sg sg"
        "m m m"
        "ls bat bat"
        "weather geyser geyser"
        "energy usage usage"
        "solar solar solar"
